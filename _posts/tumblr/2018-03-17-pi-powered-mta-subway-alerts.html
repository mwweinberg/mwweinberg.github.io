---
layout: post
title: Pi Powered MTA Subway Alerts
date: '2018-03-17T10:16:10-04:00'
tags:
- projects
tumblr_url: http://michaelweinberg.org/post/171963532565/pi-powered-mta-subway-alerts
redirect_from: "/post/171963532565/pi-powered-mta-subway-alerts/"
---
<figure class="tmblr-full" data-orig-height="3969" data-orig-width="1674"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html0.jpg" data-orig-height="3969" data-orig-width="1674"/></figure><p>This project is designed to answer the question “if I leave my house now, how long will I have to wait for my subway train?”  One way to answer that question is “if you leave right now you won’t have to wait at all”.</p><figure class="tmblr-full" data-orig-height="3969" data-orig-width="1674"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html1.jpg" data-orig-height="3969" data-orig-width="1674"/></figure><p>The project uses a raspberry pi zero to connect the NYC MTA real time arrival data with neopixels.  The neopixels give you an indication of how far trains are away from the station.  Importantly, the alerts are  not based on the absolute time until the train arrives at the station (”A train will arrive at the station in 5 minutes”).  Instead, the alerts are aware of how long it takes to walk to the station from my apartment and are therefore based on the time from the station when you get there (”If you leave now and walk to the station, there will be a train arriving in the station 5 minutes after you get there.”).</p><figure class="tmblr-full" data-orig-height="3969" data-orig-width="1674"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html2.jpg" data-orig-height="3969" data-orig-width="1674"/></figure><p>A few quick notes before getting into the details.  First, the way you arrange the indicator lights is essentially arbitrary.  We happened to abstract them out into strips.  However, you could do spirals or overlay them on a map or whatever you want.  Second, and speaking of maps, this project builds on the never quite finished <a href="https://github.com/mwweinberg/bikeshare" target="_blank">metro-and-bikeshare map</a> project from when I lived in DC. That one combines reading from the WMATA api and the DC bikeshare API with an eye towards lights integrated into a map.  If you are in DC it may or may  not be helpful for you. Third, the parts of this that parse the MTA’s API is 100% reliant on <a href="https://github.com/chris-griffin/real-time" target="_blank">Chris Griffin’s real time countdown subway display</a>.  The NYC subway API is more robust than DC’s, which means it is like a million times harder to parse if you (like me) don’t know what you are doing.  Chris’ code made everything a lot easier.</p><p>The basic outline of the project is as follows: </p><ol><li>Poll the MTA API to find out when trains will arrive at your station<br/></li><li>Pull out the trains you care about</li><li>Assign them to the relevant indicator lights</li><li>Repeat</li></ol><h2>Bill of Materials</h2><ul><li><a href="https://www.adafruit.com/product/3400" target="_blank">Rasbperry Pi Zero W</a> (you’ll need a power supply too)<br/></li><li><a href="https://www.adafruit.com/product/1734" target="_blank">Neopixels</a> (however many lights you want)</li><li><a href="https://www.adafruit.com/product/755" target="_blank">Diodes</a> (you only  need one)</li><li><a href="https://www.adafruit.com/product/753" target="_blank">0.1uF capacitors</a> (I used 1 for ever 4 neopixels)</li><li><a href="https://www.adafruit.com/product/1589" target="_blank">4700uF capacitor</a></li><li><a href="https://www.adafruit.com/product/368" target="_blank">Female DC power adapter</a></li><li>Wires</li><li>Some sort of pushbutton (if you want the pause feature)</li></ul><p>If you decide to go with the physical layout I used you will also need</p><ul><li>Mirrored acrylic (I got mind at Canal Plastics)<br/></li><li>The brackets (available in the repo and on <a href="https://www.thingiverse.com/thing:2822219" target="_blank">thingiverse</a>)</li></ul><h2>Software</h2><p>I’m assuming you already have your pi connected to your home network to get this rolling. One thing that I did discover is that you can transfer an SD card from a regular pi to a pi zero. That allowed me to prototype this entire thing on a full sized pi (with headers) before shifting it onto the zero.</p><p>Tumblr is bad at formatting code so I’ll just point to the github repo <a href="https://github.com/mwweinberg/NYC-MTA-Next-Train" target="_blank">here</a> for the entire code.  I’ll use this section to walk through important parts of the code.</p><blockquote><p>#variables to hold the lists<br/>arrival_times_york_south = []<br/>arrival_times_york_north = []<br/>arrival_times_high_south_a = []<br/>arrival_times_high_north_a = []<br/>arrival_times_high_south_c = []<br/>arrival_times_high_north_c = []<br/><br/></p></blockquote><p>This section creates the station lists.  For my purposes I care about three stations: York, High Street (A line), and High Street (C line).  Each station has two directions.  Modify these as relevant for the stations you care about.</p><blockquote><p>#variables to hold the station IDs<br/>HighS = [&lsquo;A40S&rsquo;]<br/>HighN = ['A40N&rsquo;]<br/>YorkS = ['F18S&rsquo;]<br/>YorkN = ['F18N&rsquo;]<br/><br/></p></blockquote><p>These hold the UIDs for the stations within the MTA API.  Someone made a helpful <a href="http://mtaapi.herokuapp.com/stations" target="_blank">heroku app to help you find the ids that you care about</a>.</p><blockquote><p>#variables to hold the walk times<br/>HighWalk = 13<br/>YorkWalk = 7<br/><br/></p></blockquote><p>This is how  long it takes you to walk to the station.  This is used to customize the alert time for your location.</p><blockquote><p>def grabber(station_ID, station_URL, station_line):<br/></p></blockquote><p>This function adds the arrival times to the station for every train that is in they system.  Since the MTA API has data for when every train running will reach every station, the output here can be a dozen or so numbers that are as  high as 60 minutes out.</p><blockquote><p>def lighter(arrival_list, time_start, light_one, light_two, light_three, light_four, light_five, line_R, line_G, line_B):<br/></p></blockquote><p>This function decides which of the neopixels to turn on.  “arrival_list” is the output from grabber, “time_start” will be how long it takes to walk to the station, the “light_x” is the the neopixels associated with that station in that direction, and “line_X” are the RGB colors associated with the line.  The idea here is that you tell the function when trains are coming, how to correct those arrival times for you walking to the station, what the indicator lights are, and what color they should be when they are on.</p><p>The block of if statements in this function that start with </p><blockquote><p>if  int(item) == time_start:<br/></p></blockquote><p>decide what these lights mean.  I decided to make five lights for each direction.  They are:</p><ul><li>leave now<br/></li><li>1-2 minutes until leave  now</li><li>3-4 minutes until leave now</li><li>5-7 minutes until leave now</li><li>8-12 minutes until leave now</li></ul><p>These are relatively arbitrary categories can you can change them so that they work for you.  As noted above, the basic idea is to get a sense of how long you have until you need to leave and how many trains are coming reasonably soon.  Note that the lights can’t tell the difference between 1 train being in a category and 2 or more trains being in that category.  Also, I suppose this is where I should mention that these lights are only as accurate as the MTA info they are based on.</p><blockquote><p>def blackout():<br/></p></blockquote><p>This function turns off the lights at night.  It has slightly different times for weekdays and weekends.</p><blockquote><p>def pause_button(channel):<br/></p></blockquote><p>This function is for a pause button that temporarily turns off the lights during a time when they would otherwise be on.  I don’t know if I’m going to use it (as of this moment the off time is set to 30 seconds) but if the lights are somewhere that you’ll want to be able to shut them off for random reasons this allows you to do so.</p><blockquote><p>while True:</p></blockquote><p><br/>Having  built these functions, this loop actually runs them. It ends by pausing for 5 seconds.  This is a shorter amount of time than necessary and was originally 30 seconds (this probably doesn’t need to be updated more than once a minute).  However, I’ve found that the actual downloading and parsing of the MTA data can take 15-20 seconds (sometimes even more) so I shortened it to 5 seconds.</p><h2>Hardware</h2><p>Here’s the wiring diagram:</p><figure data-orig-width="1416" data-orig-height="1035" class="tmblr-full"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html3.png" alt="image" data-orig-width="1416" data-orig-height="1035"/></figure><p>I ended up putting the diodes every fourth neopixel.</p><p>After drilling the holes in the acrylic sheet I put the neopixel through the hole and soldered in the wires:</p><figure data-orig-width="3024" data-orig-height="4032" class="tmblr-full"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html4.jpg" alt="image" data-orig-width="3024" data-orig-height="4032"/></figure><p>Here’s an image of all of them chained together:</p><figure data-orig-width="3024" data-orig-height="4032" class="tmblr-full"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html5.jpg" alt="image" data-orig-width="3024" data-orig-height="4032"/></figure><p>Wired together with the harness:</p><figure data-orig-width="4032" data-orig-height="3024" class="tmblr-full"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html6.jpg" alt="image" data-orig-width="4032" data-orig-height="3024"/></figure><p>And soldered in with the pi:</p><figure data-orig-width="4032" data-orig-height="3024" class="tmblr-full"><img src="/images/2018-03-17-pi-powered-mta-subway-alerts.html7.jpg" alt="image" data-orig-width="4032" data-orig-height="3024"/></figure><p>And that’s more or less it. Once you have things connected to your network just pick a place to hag it up.  Now you may or may not be late to a subway train again, depending on the accuracy of the MTA API data.</p>
